<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SM ছাত্রাবাস - স্মার্ট শিডিউল</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- HTML2Canvas Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #0f172a;
            color: white;
            margin: 0; padding: 0;
            overflow-x: hidden;
        }
        .font-tech { font-family: 'Rajdhani', sans-serif; }

        /* --- UI EFFECTS --- */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .neon-glow {
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }
        .result-item {
            background: rgba(30, 41, 59, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .edit-active {
            border: 1px solid #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }
        .admin-active-btn {
            background-color: #ef4444 !important; /* Red color when admin is active */
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS ---
        const IconZap = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const IconCheck = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>;
        const IconX = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>;
        const IconLock = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const IconUnlock = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>;
        const IconEdit = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>;
        const IconImage = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>;
        const IconLink = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>;
        const IconTrash = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>;

        // --- ENCODING UTILS ---
        const encodeData = (data) => {
            try { return btoa(unescape(encodeURIComponent(JSON.stringify(data)))); } catch (e) { return null; }
        };
        const decodeData = (str) => {
            try { return JSON.parse(decodeURIComponent(escape(atob(str)))); } catch (e) { return null; }
        };

        const App = () => {
            // --- STATE ---
            const [view, setView] = useState('loading'); // loading, home, result
            const [isAdmin, setIsAdmin] = useState(false);
            
            // Data State
            const [month, setMonth] = useState('December');
            const [totalDays, setTotalDays] = useState(31);
            const [year, setYear] = useState(new Date().getFullYear());
            const [members, setMembers] = useState([]);
            const [inputName, setInputName] = useState('');
            const [schedule, setSchedule] = useState([]);

            // UI State
            const [isImgMode, setIsImgMode] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const [password, setPassword] = useState('');
            const [canEditResult, setCanEditResult] = useState(false);
            const [copied, setCopied] = useState(false);
            const [shareableLink, setShareableLink] = useState('');

            // --- INITIAL LOAD ---
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const dataParam = params.get('d');

                if (dataParam) {
                    const decoded = decodeData(dataParam);
                    if (decoded) {
                        setSchedule(decoded.s);
                        setMonth(decoded.m);
                        setYear(decoded.y);
                        setMembers(decoded.p);
                        setView('result'); // Directly show result if data exists
                        // Set initial link
                        setShareableLink(window.location.href);
                    } else {
                        setView('home');
                    }
                } else {
                    setView('home');
                }
            }, []);

            // --- LOGIC ---
            const addMember = () => { if(inputName.trim()) { setMembers([...members, inputName.trim()]); setInputName(''); }};
            const removeMember = (index) => setMembers(members.filter((_, i) => i !== index));

            const generateSchedule = () => {
                if (members.length < 2) { alert("কমপক্ষে ২ জন সদস্য প্রয়োজন!"); return; }
                setView('processing');
                setTimeout(() => {
                    const days = parseInt(totalDays) || 31;
                    let newSchedule = [];
                    let lastDuty = {}; members.forEach(m => lastDuty[m] = -999); 
                    const monthMap = { "January":0, "February":1, "March":2, "April":3, "May":4, "June":5, "July":6, "August":7, "September":8, "October":9, "November":10, "December":11 };

                    for (let day = 1; day <= days; day++) {
                        let eligible = availableMembers(members, day, lastDuty);
                        const picked = eligible[Math.floor(Math.random() * eligible.length)];
                        const dateObj = new Date(year, monthMap[month] || 0, day);
                        const dayName = dateObj.toLocaleDateString('bn-BD', { weekday: 'long' });
                        newSchedule.push({ day, dayName, person: picked });
                        lastDuty[picked] = day;
                    }
                    setSchedule(newSchedule);
                    setView('result');
                    updateUrlState(newSchedule, month, year, members);
                }, 1500);
            };

            const availableMembers = (members, day, lastDuty) => {
                // Rule: Try 2 days gap, then 1 day gap
                let pool = members.filter(m => (day - lastDuty[m]) > 2);
                if (pool.length === 0) pool = members.filter(m => (day - lastDuty[m]) > 1);
                if (pool.length === 0) pool = members;
                return pool;
            }

            const updateUrlState = (sch, m, y, p) => {
                const data = { s: sch, m: m, y: y, p: p };
                const encoded = encodeData(data);
                if (encoded) {
                    const newUrl = `${window.location.pathname}?d=${encoded}`;
                    const fullUrl = `${window.location.protocol}//${window.location.host}${newUrl}`;
                    setShareableLink(fullUrl);
                    try { window.history.pushState({ path: newUrl }, '', newUrl); } catch (e) {}
                }
            };

            // --- ADMIN & EDITING ---
            const toggleAdmin = () => {
                if (isAdmin) {
                    // Turn OFF Admin
                    setIsAdmin(false);
                    setCanEditResult(false);
                } else {
                    // Turn ON Admin (Ask Password)
                    setIsAuthModalOpen(true);
                }
            };

            const handleAuthSubmit = () => {
                if (password === '8546') {
                    setIsAdmin(true);
                    setIsAuthModalOpen(false);
                    setPassword('');
                } else {
                    alert('ভুল পাসওয়ার্ড!');
                    setPassword('');
                }
            };

            const resetAll = () => {
                if(confirm('সতর্কতা: বর্তমান তালিকা মুছে ফেলা হবে। আপনি কি নিশ্চিত?')) {
                    setView('home'); setSchedule([]); setMembers([]); setIsAdmin(false);
                    setShareableLink('');
                    try { window.history.pushState({}, '', window.location.pathname); } catch(e) {}
                }
            };

            const saveEdits = () => {
                setCanEditResult(false);
                updateUrlState(schedule, month, year, members);
                alert("আপডেট করা হয়েছে!");
            };

            const copyLink = () => {
                const linkToCopy = shareableLink || window.location.href;
                const textArea = document.createElement("textarea");
                textArea.value = linkToCopy;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (e) {}
                document.body.removeChild(textArea);
            };

            // --- FULL IMAGE DOWNLOAD ---
            const downloadImage = () => {
                setIsImgMode(true);
                setTimeout(() => {
                    const element = document.getElementById('image-template-container');
                    html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff', windowHeight: element.scrollHeight + 50 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `SM_Hostel_${month}_${year}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 1.0);
                        link.click();
                        setIsImgMode(false);
                    });
                }, 500);
            };

            const displayMonth = { "January":"জানুয়ারি", "February":"ফেব্রুয়ারি", "March":"মার্চ", "April":"এপ্রিল", "May":"মে", "June":"জুন", "July":"জুলাই", "August":"আগস্ট", "September":"সেপ্টেম্বর", "October":"অক্টোবর", "November":"নভেম্বর", "December":"ডিসেম্বর" }[month] || month;

            if (view === 'loading') return <div className="min-h-screen bg-slate-900"></div>;

            return (
                <div className="min-h-screen flex justify-center bg-slate-900">
                    <div className="w-full max-w-md bg-slate-900 min-h-screen relative shadow-2xl flex flex-col overflow-hidden">
                        
                        {/* Background */}
                        <div className="fixed top-[-10%] left-[-10%] w-[50%] h-[40%] bg-purple-600/20 blur-[100px] rounded-full pointer-events-none"></div>
                        
                        {/* --- HIDDEN IMAGE TEMPLATE (Full Length for Download) --- */}
                        {isImgMode && (
                            <div id="image-template-container" style={{ position: 'absolute', top: 0, left: 0, width: '600px', background: 'white', color: 'black', padding: '40px', zIndex: 99999, fontFamily: "'Hind Siliguri', sans-serif" }}>
                                <div className="text-center mb-6">
                                    <h1 className="text-3xl font-bold mb-2 text-black">SM ছাত্রাবাস বাজার তালিকা</h1>
                                    <p className="text-xl text-gray-700">{displayMonth} {year}</p>
                                    <div className="w-full h-1 bg-black mt-4"></div>
                                </div>
                                <table style={{width: '100%', borderCollapse: 'collapse', border: '1px solid #000'}}>
                                    <thead>
                                        <tr style={{background: '#e5e7eb'}}>
                                            <th style={{border: '1px solid #000', padding: '10px', width: '20%', fontSize: '18px'}}>তারিখ</th>
                                            <th style={{border: '1px solid #000', padding: '10px', width: '30%', fontSize: '18px'}}>বার</th>
                                            <th style={{border: '1px solid #000', padding: '10px', textAlign: 'left', fontSize: '18px'}}>নাম</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {schedule.map((item, idx) => (
                                            <tr key={idx}>
                                                <td style={{border: '1px solid #000', padding: '10px', textAlign: 'center', fontWeight: 'bold', fontSize: '18px'}}>{item.day}</td>
                                                <td style={{border: '1px solid #000', padding: '10px', textAlign: 'center', fontSize: '16px'}}>{item.dayName}</td>
                                                <td style={{border: '1px solid #000', padding: '10px', fontWeight: 'bold', fontSize: '18px'}}>{item.person}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="mt-10 text-center text-sm text-gray-500"><p>Created by: SM Manager App</p></div>
                            </div>
                        )}

                        {/* --- INPUT VIEW (HOME) --- */}
                        {view === 'home' && (
                            <div className="p-6 flex-1 flex flex-col animate-enter z-10">
                                <div className="mt-8 mb-8">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="h-1 w-8 bg-purple-500 rounded-full"></div>
                                        <span className="text-xs font-tech tracking-[0.2em] text-purple-400 uppercase">সিস্টেম রেডি</span>
                                    </div>
                                    <h1 className="text-4xl font-bold text-white">SM <span className="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">ছাত্রাবাস</span></h1>
                                </div>

                                <div className="glass-card rounded-3xl p-6 mb-6">
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="text-xs text-gray-400 font-bold uppercase">মাস</label>
                                            <select value={month} onChange={e => setMonth(e.target.value)} className="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl p-3 mt-1 outline-none font-tech">
                                                {["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"].map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-400 font-bold uppercase">মোট দিন</label>
                                            <input type="number" value={totalDays} onChange={e => setTotalDays(e.target.value)} className="w-full bg-slate-800/50 border border-slate-700 text-white rounded-xl p-3 mt-1 outline-none font-tech"/>
                                        </div>
                                    </div>
                                    <div className="mb-4">
                                        <label className="text-xs text-gray-400 font-bold uppercase">সদস্য যোগ করুন</label>
                                        <div className="flex gap-2 mt-1">
                                            <input type="text" value={inputName} onChange={e => setInputName(e.target.value)} onKeyDown={e => e.key === 'Enter' && addMember()} placeholder="নাম..." className="flex-1 bg-slate-800/50 border border-slate-700 text-white rounded-xl p-3 outline-none"/>
                                            <button onClick={addMember} className="bg-purple-600 p-3 rounded-xl text-white"><IconCheck /></button>
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {members.map((m, i) => (
                                            <span key={i} className="flex items-center gap-1 bg-slate-800 text-purple-300 px-3 py-1 rounded-full text-sm border border-slate-700">
                                                {m} <button onClick={() => removeMember(i)} className="text-gray-500 hover:text-red-400 ml-1"><IconX /></button>
                                            </span>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex-1"></div>
                                <button onClick={generateSchedule} className="w-full py-4 rounded-2xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold text-lg shadow-lg neon-glow mb-8 flex justify-center items-center gap-2">
                                    <IconZap /> লটারি শুরু করুন
                                </button>
                            </div>
                        )}

                        {/* --- PROCESSING --- */}
                        {view === 'processing' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-6 bg-slate-900 z-20">
                                <div className="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <p className="text-purple-400 font-tech tracking-widest animate-pulse">GENERATING...</p>
                            </div>
                        )}

                        {/* --- RESULT VIEW (LOCKED/ADMIN) --- */}
                        {view === 'result' && (
                            <div className="flex-1 flex flex-col h-screen bg-slate-900 z-20">
                                <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900 shadow-md">
                                    <div>
                                        <h2 className="text-xs font-bold uppercase flex items-center gap-2">
                                            {isAdmin ? <span className="text-red-400">অ্যাডমিন মোড</span> : <span className="text-purple-400">রিড অনলি</span>}
                                        </h2>
                                        <h1 className="text-xl font-bold text-white">{displayMonth} {year}</h1>
                                    </div>
                                    <button onClick={copyLink} className="flex items-center gap-1 px-3 py-1.5 rounded-full bg-slate-800 text-xs text-gray-300 hover:text-white border border-slate-700 transition-all active:scale-95">
                                        {copied ? 'কপি হয়েছে!' : <><IconLink /> শেয়ার লিংক</>}
                                    </button>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 pb-24 bg-slate-900">
                                    <div className="space-y-2">
                                        {schedule.map((item, idx) => (
                                            <div key={idx} className={`result-item p-3 rounded-lg flex items-center justify-between ${canEditResult ? 'edit-active' : ''}`}>
                                                <div className="flex items-center gap-4 w-full">
                                                    <div className="flex flex-col items-center justify-center w-12 h-12 bg-slate-800 rounded text-center">
                                                        <span className="text-lg font-bold text-purple-400">{item.day}</span>
                                                        <span className="text-[10px] text-gray-400 uppercase">{item.dayName.slice(0,3)}</span>
                                                    </div>
                                                    <div className="w-full">
                                                        <p className="text-xs text-gray-500">{item.dayName}</p>
                                                        {canEditResult ? (
                                                            <select className="bg-slate-900 text-white p-2 rounded border border-purple-500 outline-none text-sm mt-1 w-full" value={item.person} onChange={(e) => {
                                                                const newSch = [...schedule]; newSch[idx].person = e.target.value; setSchedule(newSch);
                                                            }}>
                                                                {members.map(m => <option key={m} value={m}>{m}</option>)}
                                                            </select>
                                                        ) : (
                                                            <h3 className="text-lg font-bold text-white">{item.person}</h3>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-slate-800 border-t border-slate-700 flex gap-3 z-30">
                                    {/* Normal User View */}
                                    {!isAdmin && (
                                        <button onClick={downloadImage} className="w-full py-3 rounded-xl bg-green-600 text-white font-bold flex justify-center items-center gap-2 shadow-lg active:scale-95 transition-transform">
                                            <IconImage /> ছবি ডাউনলোড
                                        </button>
                                    )}

                                    {/* Admin View */}
                                    {isAdmin && (
                                        <>
                                            {canEditResult ? (
                                                <button onClick={saveEdits} className="w-full py-3 rounded-xl bg-purple-600 text-white font-bold flex justify-center items-center gap-2"><IconCheck /> সেভ করুন</button>
                                            ) : (
                                                <>
                                                    <button onClick={resetAll} className="flex-1 py-3 rounded-xl bg-red-900/50 text-red-300 font-bold flex justify-center gap-2 items-center"><IconTrash /> রিসেট</button>
                                                    <button onClick={() => setCanEditResult(true)} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold flex justify-center gap-2 items-center"><IconEdit /> এডিট</button>
                                                    <button onClick={downloadImage} className="flex-1 py-3 rounded-xl bg-green-600 text-white font-bold flex justify-center gap-2 items-center"><IconImage /> IMG</button>
                                                </>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- ADMIN TRIGGER (Hidden/Small) --- */}
                        <div 
                            className={`fixed bottom-1 right-1 z-50 cursor-pointer p-2 rounded-full transition-all duration-300 ${isAdmin ? 'admin-active-btn text-white opacity-100' : 'text-gray-600 hover:text-white opacity-10 hover:opacity-100'}`} 
                            onClick={toggleAdmin}
                            title="Admin Access"
                        >
                            {isAdmin ? <IconUnlock /> : <IconLock />}
                        </div>

                        {/* --- AUTH MODAL --- */}
                        {isAuthModalOpen && (
                            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50 animate-enter">
                                <div className="bg-slate-800 w-full rounded-2xl p-6 border border-slate-700 shadow-2xl">
                                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><IconLock /> পাসওয়ার্ড দিন</h3>
                                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-center text-2xl tracking-[0.5em] text-white outline-none focus:border-purple-500 mb-4" autoFocus placeholder="****" />
                                    <div className="flex gap-3">
                                        <button onClick={() => setIsAuthModalOpen(false)} className="flex-1 py-3 bg-slate-700 rounded-lg text-white">বাতিল</button>
                                        <button onClick={handleAuthSubmit} className="flex-1 py-3 bg-purple-600 rounded-lg text-white font-bold">আনলক</button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>